<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Test Resize</title>
   <link rel="stylesheet" href="icons/bootstrap-icons.min.css">
   <link href="bootstrap/bootstrap.css" integrity="sha384-qAlWxD5RDF+aEdUc1Z7GR/tE4zYjX1Igo/LrIexlnzM6G63a6F1fXZWpZKSrSW86" rel="stylesheet" crossorigin="anonymous">
   <script src="bootstrap/bootstrap.bundle.js" integrity="sha384-5xO2n1cyGKAe630nacBqFQxWoXjUIkhoc/FxQrWM07EIZ3TuqkAsusDeyPDOIeid" crossorigin="anonymous"></script>
   <script src="test.js"></script>
   <style>
      .js-window {
         --border-color: #333;
         background-color: black; color: white;
         border-radius: 12px 12px 0 0; border: 1px var(--border-color) solid;
         box-sizing: border-box; position: fixed;
         display: grid; grid-template-rows: auto 1fr;
      }
      .js-d-none {
         display: none;
      }
      .js-window .js-head {
         flex: 0 0 auto;
         box-sizing: border-box;
         border-bottom: 1px var(--border-color) solid;
         display: flex; flex-flow: row nowrap;
         overflow: hidden;
      }
      .js-window .js-body {
         flex: 1 1 auto;
         background-color: lightcoral;
         box-sizing: border-box;
         overflow: hidden; contain: layout;
         display: grid; place-items: stretch;
      }
      .js-window .js-head .js-controls {
         flex: 0 0 auto; align-self: center; order: 2;
         padding: 3px 5px 3px 3px;
      }
      .js-window .js-head .js-title {
         flex: 1 1 auto; align-self: stretch; order: 1;
         border-radius: 12px 0 0 0; padding: 3px 0px 3px 10px;
         box-sizing: border-box; overflow: hidden; white-space: nowrap;
      }
      .js-controls [data-slot='min'], .js-controls [data-slot='max'], .js-controls [data-slot='close'] {
         margin-left: 0.5em; padding: 2px 3px;
         box-sizing: border-box;
         width: 1em;
         cursor: pointer;
      }
      .js-controls [data-slot='min']:hover, .js-controls [data-slot='max']:hover, .js-controls [data-slot='close']:hover {
         padding-left: 4px; padding-right: 2px;
         background-color: lightslategray;
      }
      .js-controls .maximized[data-slot='max']::before {
         text-decoration: underline dotted;
      }
      .js-controls [data-slot='close']:hover {
         background-color: lightcoral;
      }

      .js-window-stack {
         border: 1px darkgrey solid; background-color: lemonchiffon;
         padding: 3px;
         position: fixed; left: 5px; bottom: 5px;
         display: flex; flex-flow: column-reverse nowrap; place-items: stretch; gap: 5px;
      }
      .js-window-stack > * {
         position: static;
      }
      .js-window-stack .js-window .js-title:hover {
         background-color: lightslategray;
         cursor: pointer;
      }
      .js-window-stack button {
         color:white; background-color:cadetblue;
         border:1px darkgoldenrod solid;
         padding:3px;
      }
      .js-window-stack button:hover {
         color:#fafafa;
         outline:1px darkgoldenrod solid;
         padding:4px 2px 2px 4px;
      }
      .dropzone {
         border:2px white dashed;
      }
      .dropzone.dropallowed {
         box-shadow: inset 0 0 3px 2px #33773A;
      }
      .dropzone.dropforbidden {
         box-shadow: inset 0 0 3px 2px red;
      }
   </style>
</head>
<body>
   <template id="js-window-template">
      <!-- use  » data-config="hiddenClassName: class-name, ..." « to config other class name for hidden=true ==> (display=none) -->
      <div class="js-window">
         <div class="js-head" data-slot="minimized-height">
            <div class="js-title" data-slot="title"></div>
            <div class="js-controls"><i data-slot="min" class="bi-dash-lg"></i><i data-slot="max" class="bi-square"></i><i data-slot="close" class="bi-x-lg"></i></div>
         </div>
         <div class="js-body" data-slot="content"></div>
      </div>
   </template>
   <template id="js-minimized-window-template">
      <div class="js-window">
         <div class="js-head">
            <div class="js-title" data-slot="title"></div>
            <div class="js-controls"><i data-slot="close" class="bi-x-lg"></i></div>
         </div>
      </div>
   </template>
   <h3>Test Move & Resize Divs</h3>
   <dl>
      <dt>Components</dt>
      <dd>
         <ul>
            <li>View (Encapsulates HTMLElement)</li>
            <li>View-Model (Adds operations/logic to View)</li>
            <li>View-Controller (Event-Listeners-Handling (no logic))</li>
            <li>Decorator (Binds HTMLElement to View,-Model,-Controller)</li>
         </ul>
      </dd>
      <dt>Missing Features</dt>
      <dd>
         <ul>
            <li>All things Model</li>
         </ul>
      </dd>
   </dl>

   <div id=window class="dropzone" style="width:30%;height:150px;background-color:darkblue;color:white;font-size:18px;padding:18px;text-align:center;overflow:auto;box-sizing:border-box;position:relative;left:30px;">
      <div>Drop Image (for upload)</div>
      <div>call testrun()</div>
   </div>

   <div id=window2 style="position:absolute;left:440px;top:160px;width:200px;height:150px;background-color:darkviolet;color:white;font-size:18px;padding:18px;text-align:center;overflow:visible;box-sizing:border-box;">
      (absolute)<br>undecorate with test3()
   </div>

   <div id=window3 style="position:fixed;left:300px;top:230px;width:200px;height:150px;background-color:teal;color:white;font-size:18px;padding:18px;text-align:center;overflow:visible;box-sizing:border-box;">
      (fixed)<br>call test() or test2()
   </div>

   <div class="js-window-stack">
      <button>Restore closed window</button>
   </div>

   <code><pre style="margin-block:8px">
      # start upload server (localhost:9090)
      > bun server.js</pre></code>
   <div>== LOG ==</div>
   <div id="LOG"></div>
   <div style="height:1000px;"></div>

   <script>
      /////////
      // LOG //
      /////////
      let logLines = 0
      const logError = (msg) => {
         ++ logLines
         let append = document.getElementById("LOG").innerHTML
         if (logLines > 15) {
            append = append.substring(0,append.lastIndexOf("<br>"))
         }
         document.getElementById("LOG").innerHTML = (logLines%100) + " " + msg + "<br>" + append
      }
      window.addEventListener("error", (e) => {
         if (e.error?.stack)
            e.error.stack.toString().split("\n").reverse().forEach(traceLine => traceLine.trim() && logError("&nbsp; "+traceLine))
         logError(`line ${e.lineno}: ${e.message}`)
      })
   </script>

   <script src="./htmlview.js"></script>

   <script>
      //////////////////
      // TEST SECTION //
      //////////////////

      const div1 = document.getElementById("window")
      const div2 = document.getElementById("window2")
      const div3 = document.getElementById("window3")

      const win1VM = new WindowDecorator(div1, { title: "Hello 1" }).viewModel
      const win2VM = new WindowDecorator(div2, { template:"#js-window-template", title: "Hello 2" }).viewModel
      const win3VM = new WindowDecorator(div3, { template:View.clone("#js-window-template"), title: "Hello 3"}).viewModel
      const win4VM = new WindowVM(View.clone("#js-window-template")).setOptions({
         top:240, left:600, width:140, height:100, title:"Hello 4",
         content: "<div style='background-color:beige; color:maroon;'>Created Window</div>"
      })
      new WindowDecorator(win4VM.htmlElem, { viewModel: win4VM, moveable:null/*chosen in decorator*/ })
      win4VM.vWindowState = "visible"

      const child = View.newElement("<div style='background-color:#154360; color:#eafaf1; position:fixed; width:95px; height:85px;'>Created Window</div>")
      const win5VM = new WindowDecorator(child).viewModel
      win5VM.vWindowState = "visible"

      console.log("listened elements",ViewListeners.getListenedElements(document))
      console.log("WindowDecorator decorated elements",ViewDecorators.getDecoratedElements(document,WindowDecorator))

      const winstackVM = new WindowStackVM(View.query("[class='js-window-stack']"))

      View.query("[class='js-window-stack'] button").addEventListener("click", (e) => {
         if (win1VM.vWindowState === WindowVM.CLOSED)
            (win1VM.vWindowState = WindowVM.VISIBLE, winstackVM.register(win1VM))
         else if (win2VM.vWindowState === WindowVM.CLOSED)
            (win2VM.vWindowState = WindowVM.VISIBLE, winstackVM.register(win2VM))
         else if (win3VM.vWindowState === WindowVM.CLOSED)
            (win3VM.vWindowState = WindowVM.VISIBLE, winstackVM.register(win3VM))
         else if (win4VM.vWindowState === WindowVM.CLOSED)
            (win4VM.vWindowState = WindowVM.VISIBLE, winstackVM.register(win4VM))
      })

      winstackVM.register(win1VM)
      winstackVM.register(win2VM)
      winstackVM.register(win3VM)
      winstackVM.register(win4VM)
      winstackVM.register(win5VM)

      const deco1 = ViewDecorators.get(win1VM.htmlElem, WindowDecorator)[0]
      const deco2 = ViewDecorators.get(win2VM.htmlElem, WindowDecorator)[0]
      const deco3 = ViewDecorators.get(win3VM.htmlElem, WindowDecorator)[0]
      const deco4 = ViewDecorators.get(win4VM.htmlElem, WindowDecorator)[0]
      const deco5 = ViewDecorators.get(win5VM.htmlElem, WindowDecorator)[0]

      logError(devicePixelRatio+"dppx")

      function test() {
         console.log("win3VM.vWindowState=",win3VM.vWindowState)
         //win3VM.vWindowState="hidden"
         //win3VM.vWindowState="maximized"
         //win3VM.vWindowState="visible"
         win3VM.vWindowState="maximized"
         setTimeout( () => {
            win3VM.vWindowState="visible"
            setTimeout( () => {
               win3VM.vWindowState="minimized"
               setTimeout( () => {
                  win3VM.vWindowState="visible"
               }, 130)
            }, 30)
         }, 100)
      }

      function test2() {
         const oldPos = win3VM.visiblePos
         console.log("old win3VM.visiblePos", oldPos)
         win3VM.visiblePos = { width:500, height:300, top:50, left:50, transition:true }
         setTimeout( () => {
            win3VM.visiblePos = oldPos
         }, 600)
      }

      let redecorationCount = 0
      function test3() {
         deco2.undecorate()
         setTimeout( () => {
            deco2.decorate(div2, {viewModel:win2VM, title:`Hello 2-(${++redecorationCount})`})
            win2VM.vTop -= 10+redecorationCount
         }, 800)
      }

      const dropzone = View.query(".dropzone")
      const scrollDown = () => new ViewUpdateListener( () => {
                                    dropzone.scrollBy({top:1000, behavior:"smooth"})
                                 }, 1)
      function do_upload_image(file) {
         if (!file.type.startsWith("image/")) {
            dropzone.innerHTML += `<br>Failed: unexpected type »${file.type}«`
            scrollDown()
         }
         else {
            const fr = new FileReader()
            fr.readAsDataURL(file)
            fr.addEventListener("loadend", (e) => {
               if (fr.error)
                  dropzone.innerHTML += `<br>error reading file »${file.name}«`
               else {
                  dropzone.innerHTML += `<br>try uploading <img src='${fr.result}' width="30px">`
                  upload_file(file).then(result => {
                     dropzone.innerHTML += `<br>${result.ok?'':'Failed: '}${result.answer||result.error?.message}`
                     scrollDown()
                  })
               }
               scrollDown()
            })
         }
      }

      var dc1 = new DropController(dropzone, (e) => {
         console.log(e.type,"target",e.target,"items",e.items)
         const items = [...e.items]
         switch (e.type) {
            case "dropstart":
               const allowed = items.every(item => item.kind == "file" && item.type.startsWith("image/"))
               e.target.classList.add(allowed ? "dropallowed" : "dropforbidden")
               break
            case "dropend":
               e.target.classList.remove("dropallowed","dropforbidden")
               break
            case "drop":
               const wrongItems = items.filter(item => item.kind != "file" || !item.type.startsWith("image/"))
               if (wrongItems.length)
                  dropzone.innerHTML += `<br>Failed: unexpected type »${wrongItems[0].kind!=='file' && wrongItems[0].kind || wrongItems[0].type}«`
               else
                  do_upload_image(items[0].getAsFile())
               scrollDown()
               break
         }
      })

      function upload_file(file) {
         const result = { ok:false, status:0, answer:"", error:null }
         return fetch(`http://${window.location.hostname}:9090/uploads/${file.name}`, {
            method:"PUT",
            mode:"cors",
            headers: {
               "Content-Type": file.type
            },
            body:file,
         }).then( resp => {
            result.ok = resp.ok; result.status = resp.status; return resp.text()
         }).then( answer => {
            result.answer = answer; return result
         }).catch( error => {
            result.ok = false; result.error = error; return result
         })
      }

      const fileinput = View.newElement("<input type=file hidden>")
      dropzone.append(fileinput)
      new ClickController(dropzone, () => fileinput.click())
      fileinput.addEventListener("change", (e) => {
         if (fileinput.files?.length) {
            do_upload_image(fileinput.files[0])
            fileinput.value = ""
         }
      })

      function testrun() {

         async function test_window(vm) {

            await RUN_TEST({name:"vLeft changes during transition",timeout:1000}, async () => {
               vm.vWindowState = "visible"
               await vm.asyncOnTransitionEnd()
               TEST(vm.vWindowState,'=',"visible", "wrong precondition: window not in state 'visible'")
               const visibleLeft = vm.vLeft
               vm.vWindowState = "minimized"
               TEST(vm.htmlElem.getAnimations().length,'=',0, "transition not started")
               let onceCalled = 0
               await SUB_TEST({delay:300}, async () => {
                  const minimizedLeft = vm.vLeft
                  vm.vWindowState = "visible"
                  vm.onceOnTransitionEnd(() => {
                     TEST(vm.vLeft,'=',visibleLeft, "vLeft same at end of transition")
                  })
                  vm.onceOnViewUpdate( () => {
                     TEST(vm.vLeft,'range',[minimizedLeft+1,visibleLeft-1], "vLeft changes during transition gradually")
                     ++ onceCalled
                  }, 2)
                  TEST(vm.vLeft,'=',minimizedLeft, "transition not started so vLeft has not chanhged")
                  await vm.asyncOnTransitionEnd()
               })
               TEST(onceCalled,'=',1, "onceOnViewUpdate called exactly once")
            })

            await RUN_TEST({name:"vLeft == 0 if window maximized",timeout:1000}, () => {
               const left = vm.vLeft
               TEST(left,'>',1, "wrong precondition: vLeft not greater 1")
               vm.vWindowState = "maximized"
               vm.onceOnTransitionEnd(() => {
                  TEST(vm.vLeft,'=',0, "vLeft == 0 in maximized state")
               })
               vm.onceOnViewUpdate(() => {
                  TEST(vm.vLeft,'range',[1,left-1], "vLeft changes during transition")
               }, 4)
            })

            // TODO: add more tests

            END_TEST()
         }

         test_window(win1VM)
      }
   </script>

   <script>
      //////////////////////////
      // Debug Control Center //
      //////////////////////////
      class ControlCenter {
         log={}
         panel={}
         constructor() {
            const log = this.log
            log.ID = View.nextUnusedID("LogWindow")
            log.htmlElem = this.createLogWindowElement(log.ID)
            log.winVM = new WindowVM(log.htmlElem)
            log.decorator = new WindowDecorator(log.htmlElem, {viewModel:log.winVM})
            log.winVM.vWindowState="visible"
            log.width = log.winVM.vWidth
            log.decorator.setOnClose(this.hideLogWindow.bind(this))
            const panel = this.panel
            panel.ID = View.nextUnusedID("ControlPanel")
            panel.htmlElem = this.createPanel(panel.ID)
            panel.logWindowCheckbox = panel.htmlElem.querySelector("[data-slot=LogWindowCheckbox]")
            panel.winVM = new WindowVM(panel.htmlElem)
            panel.decorator = new WindowDecorator(panel.htmlElem, {viewModel:panel.winVM})
            panel.winVM.vWindowState="visible"
            panel.top = panel.winVM.vTop
            panel.decorator.setOnClose(this.hidePanel.bind(this))
            panel.keydown = document.addEventListener("keydown", (e) => {
               (e.key === "Escape") && this.togglePanel()
            })
            panel.logChanged = panel.logWindowCheckbox.addEventListener("change", (e) => {
               this.switchLogWindow(panel.logWindowCheckbox.checked)
            })
         }

         showLogWindow() {
            // TODO: use ControlCenterVM for LogWindowShown true/false
            this.log.winVM.vWindowState="visible"
            this.log.winVM.visiblePos = {transition:true, width:this.log.width}
            this.panel.logWindowCheckbox.checked = true
         }
         hideLogWindow() {
            this.log.width = this.log.winVM.vWidth
            this.log.winVM.visiblePos = {transition:true, width:0}
            this.panel.logWindowCheckbox.checked = false
            this.log.winVM.onceOnTransitionEnd( () => {
               this.log.winVM.vWindowState="hidden"
            })
         }
         switchLogWindow(switchOn) {
            switchOn ? this.showLogWindow() : this.hideLogWindow()
         }

         showPanel() {
            // TODO: use ControlCenterVM for PanelShown true/false
            this.panel.winVM.visiblePos = {transition:true, top:this.panel.top}
         }
         hidePanel() {
            this.panel.top = this.panel.winVM.vTop
            this.panel.winVM.visiblePos = {transition:true, top:-this.panel.winVM.vHeight-30}
         }
         togglePanel() {
            this.panel.winVM.vTop < 0 ? this.showPanel() : this.hidePanel()
         }

         createLogWindowElement(logID) {
            return View.newElement(`
               <div id="${logID}" style="position:fixed; width:50%;">
                  <div class="card overflow-hidden" style="height:100%">
                     <div class="card-header">
                        <span data-slot="title">Log Window</span>
                        <button type="button" class="btn-close float-end" aria-label="Close" data-slot="close"></button>
                     </div>
                     <div class="card-body overflow-y-scroll" data-slot="content">
                        <table class="w-100">
                           <thead>
                              <tr><th>nr&nbsp;</th><th>ms</th><th>name</th><th>msg</th></tr>
                           </thead>
                           <tbody>
                              <tr><td>1.</td><td>1234567</td><td>Log-Window</td><td>Shown</td></tr>
                           </tbody>
                        </table>
                     </div>
                  </div>
               </div>`
            )
         }

         createPanel(panelID) {
            return View.newElement(`
               <div id="${panelID}" class="toast show position-fixed" style="top:0; left:0;" role="alert" aria-live="assertive" aria-atomic="true">
                  <div class="toast-header">
                     <div class="rounded me-2 bg-secondary bg-gradient" style="width:1.3em">&nbsp;</div>
                     <strong class="me-auto" data-slot="title">Control Center</strong>
                     <small>Toggle with ESC</small>
                     <button type="button" class="btn-close" aria-label="Close" data-slot="close"></button>
                  </div>
                  <div class="toast-body" data-slot="content">
                     Hello, world! This is under construction.
                     <div class="form-check form-switch"><small><label class="form-check-label"><input class="form-check-input" type="checkbox" value="" checked data-slot="LogWindowCheckbox">Log Window</label></small></div>
                  </div>
               </div>`
            )
         }

         info() {
            console.log(getComputedStyle(this.log.htmlElem))
            console.log(getComputedStyle(this.log.htmlElem)["-z-index"])
         }
      }

      const ccc = new ControlCenter()
   </script>



</body>
</html>